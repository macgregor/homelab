---
# MikroTik Configuration Playbook
#
# Idempotent - safe to re-run. Connects as {{ ansible_user }} on 192.168.1.1
# (set up by mikrotik-bootstrap.yml). Configures system settings, DHCP,
# DNS, static leases, service hardening, firmware, and auto-updates.
#
# Configuration is defined in group_vars/router.yaml:
# - router_timezone: System timezone
# - router_dns_servers: Upstream DNS servers
# - router_static_leases: MAC-to-IP mapping (reads MAC addresses from .envrc)
#
# Usage:
#   cd ansible
#   ansible-playbook mikrotik-configure.yml

- name: Configure MikroTik router
  hosts: edge
  gather_facts: no

  vars:
    # RouterOS SSH requires a +cet<n>w suffix for terminal compatibility — handled here,
    # never in user-facing config. Mirrors bootstrap's factory_user → ansible_user pattern.
    base_user: "{{ router_user }}"
    ansible_user: "{{ router_user }}+cet512w"

  tasks:
    # ── Sanity checks ───────────────────────────────────────────────────
    # Verify bootstrap prerequisites before touching anything destructive.
    # If either check fails, run mikrotik-bootstrap.yml first.

    - name: Verify dhcp-pool exists
      community.routeros.command:
        commands:
          - ":put [:len [/ip pool find name=dhcp-pool]]"
      register: pool_check
      failed_when: pool_check.stdout[0] | int == 0

    - name: Verify dhcp-lan exists
      community.routeros.command:
        commands:
          - ":put [:len [/ip dhcp-server find name=dhcp-lan]]"
      register: lan_check
      failed_when: lan_check.stdout[0] | int == 0

    # ── System ──────────────────────────────────────────────────────────

    - name: Set system identity
      community.routeros.command:
        commands:
          - /system identity set name=edge

    - name: Set timezone
      community.routeros.command:
        commands:
          - /system clock set time-zone-name={{ router_timezone }}

    - name: Enable NTP client
      community.routeros.command:
        commands:
          - /system ntp client set enabled=yes

    - name: Set NTP servers
      community.routeros.command:
        commands:
          - ":if ([:len [/system ntp client servers find address=time.cloudflare.com]] = 0) do={ /system ntp client servers add address=time.cloudflare.com }"
          - ":if ([:len [/system ntp client servers find address=pool.ntp.org]] = 0) do={ /system ntp client servers add address=pool.ntp.org }"

    - name: Enable strong SSH crypto
      community.routeros.command:
        commands:
          - /ip ssh set strong-crypto=yes

    # ── User cleanup ───────────────────────────────────────────────────

    - name: Remove factory admin user
      community.routeros.command:
        commands:
          - /user remove [find name=admin]
      ignore_errors: true  # May already be removed

    # ── DHCP tuning ────────────────────────────────────────────────────

    - name: Set DHCP pool range to .50-.199
      community.routeros.command:
        commands:
          - /ip pool set [find name=dhcp-pool] ranges=192.168.1.50-192.168.1.199

    - name: Set DHCP lease time
      community.routeros.command:
        commands:
          - /ip dhcp-server set [find name=dhcp-lan] lease-time=1d

    # ── DNS ────────────────────────────────────────────────────────────

    - name: Set upstream DNS servers
      community.routeros.command:
        commands:
          - /ip dns set servers={{ router_dns_servers }}

    # ── Static DHCP leases ─────────────────────────────────────────────

    - name: Ensure static DHCP leases are correct
      community.routeros.command:
        commands:
          - >-
            :if ([:len [/ip dhcp-server lease find mac-address={{ item.mac }} address={{ item.ip }}]] = 0) do={
            /ip dhcp-server lease remove [find mac-address={{ item.mac }}];
            /ip dhcp-server lease add address={{ item.ip }} mac-address={{ item.mac }} server=dhcp-lan comment="{{ item.name }}"
            }
      loop: "{{ router_static_leases }}"
      loop_control:
        label: "{{ item.name }} ({{ item.ip }})"

    # ── Service hardening ──────────────────────────────────────────────

    - name: Disable unused services
      community.routeros.command:
        commands:
          - /ip service disable {{ item }}
      loop: [telnet, ftp, api, api-ssl]

    - name: Restrict services to LAN
      community.routeros.command:
        commands:
          - /ip service set {{ item }} address=192.168.1.0/24
      loop: [ssh, winbox, www]

    # ── Discovery hardening ────────────────────────────────────────────

    - name: Disable MAC server ping
      community.routeros.command:
        commands:
          - /tool mac-server ping set enabled=no

    - name: Disable neighbor discovery on WAN
      community.routeros.command:
        commands:
          - /ip neighbor discovery-settings set discover-interface-list=LAN

    - name: Disable bandwidth server
      community.routeros.command:
        commands:
          - /tool bandwidth-server set enabled=no

    # ── Auto-update scheduler ──────────────────────────────────────────
    #
    # auto-update.rsc stays on the router — the scheduler calls it daily.
    # configure-auto-update.rsc is a setup script run once (cleaned up below).

    - name: Upload auto-update scripts to router
      ansible.builtin.shell: >-
        scp
        -i {{ ssh_pub_key | regex_replace('\.pub$', '') }}
        -o StrictHostKeyChecking=no
        -o UserKnownHostsFile=/dev/null
        {{ item }}
        {{ base_user }}@{{ ansible_host }}:/{{ item | basename }}
      delegate_to: localhost
      ignore_errors: true
      register: upload_results
      loop:
        - "{{ playbook_dir }}/files/auto-update-packages.rsc"
        - "{{ playbook_dir }}/files/auto-update-firmware.rsc"
        - "{{ playbook_dir }}/files/configure-auto-update.rsc"
      loop_control:
        label: "{{ item | basename }}"

    - name: Report upload failures
      debug:
        msg:
          - "file:   {{ item.item | basename }}"
          - "stdout: {{ item.stdout }}"
          - "stderr: {{ item.stderr }}"
      loop: "{{ upload_results.results | selectattr('failed') | list }}"
      loop_control:
        label: "{{ item.item | basename }}"

    - name: Fail if any upload failed
      fail:
        msg: "One or more file uploads failed — see above for details"
      when: upload_results.results | selectattr('failed') | list | length > 0

    - name: Import auto-update setup script
      community.routeros.command:
        commands:
          - /import file-name=configure-auto-update.rsc
      register: auto_update_import
      ignore_errors: true

    - name: Alert if scheduler setup failed
      debug:
        msg:
          - "WARNING: Auto-update schedulers were not created"
          - "This device may have device-mode restrictions on /system scheduler"
          - "To enable scheduler: ssh {{ base_user }}@{{ ansible_host }} '/system device-mode update mode=advanced'"
          - "Then press the reset/mode button on the device within 5 minutes (or power-cycle)"
          - "Once rebooted, re-run this playbook: ansible-playbook mikrotik-configure.yml"
      when: auto_update_import is failed

    # ── Cleanup ────────────────────────────────────────────────────────

    - name: Remove temporary script files from router
      community.routeros.command:
        commands:
          - /file remove {{ item }}
      loop:
        - bootstrap-migrate-subnet.rsc
        - configure-auto-update.rsc
      ignore_errors: true  # Files may not be present on every run
      # Note: auto-update-packages.rsc and auto-update-firmware.rsc are intentionally
      # kept on the router — the schedulers call them daily via /import.
