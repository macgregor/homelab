---
# MikroTik Configuration Playbook
#
# Idempotent - safe to re-run. Connects as {{ ansible_user }} on 192.168.1.1
# (set up by mikrotik-bootstrap.yml). Configures system settings, DHCP,
# DNS, static leases, service hardening, firmware, and auto-updates.
#
# Configuration is defined in group_vars/router.yaml:
# - router_timezone: System timezone
# - router_dns_servers: Upstream DNS servers
# - router_static_leases: MAC-to-IP mapping (reads MAC addresses from .envrc)
#
# Usage:
#   cd ansible
#   ansible-playbook mikrotik-configure.yml

- name: Configure MikroTik router
  hosts: edge
  gather_facts: no

  vars:
    # RouterOS SSH requires a +cet<n>w suffix for terminal compatibility — handled here,
    # never in user-facing config. Mirrors bootstrap's factory_user → ansible_user pattern.
    base_user: "{{ router_user }}"
    ansible_user: "{{ router_user }}+cet512w"

  tasks:
    # ── Sanity checks ───────────────────────────────────────────────────
    # Verify bootstrap prerequisites before touching anything destructive.
    # If either check fails, run mikrotik-bootstrap.yml first.

    - name: Verify bootstrap prerequisites
      community.routeros.command:
        commands:
          - ":put [:len [/ip pool find name=dhcp-pool]]"
          - ":put [:len [/ip dhcp-server find name=dhcp-lan]]"
      register: _prereqs
      failed_when: _prereqs.stdout[0] | int == 0 or _prereqs.stdout[1] | int == 0

    # ── Gather current state ─────────────────────────────────────────
    # Batch state queries into one SSH round-trip. Results are used as
    # `when:` conditions throughout the playbook to skip no-op tasks.

    - name: Query router state
      community.routeros.command:
        commands:
          - ':put [:len [/user find name=admin]]'
          - ':put [:len [/system ntp client servers find address=time.cloudflare.com]]'
          - ':put [:len [/system ntp client servers find address=pool.ntp.org]]'
          - ':put [:len [/certificate find common-name="SSL.com Root Certification Authority ECC"]]'
          - ':put [:len [/ip dns static find comment="split-dns"]]'
      register: _state

    - name: Set state facts
      ansible.builtin.set_fact:
        _has_admin_user: "{{ _state.stdout[0] | int > 0 }}"
        _has_ntp_cloudflare: "{{ _state.stdout[1] | int > 0 }}"
        _has_ntp_pool: "{{ _state.stdout[2] | int > 0 }}"
        _has_doh_cert: "{{ _state.stdout[3] | int > 0 }}"
        _has_split_dns: "{{ _state.stdout[4] | int > 0 }}"

    # ── System ──────────────────────────────────────────────────────────

    - name: Configure system settings
      community.routeros.command:
        commands:
          - /system identity set name=edge
          - /system clock set time-zone-name={{ router_timezone }}
          - /system ntp client set enabled=yes
          - /ip ssh set strong-crypto=yes

    - name: Add NTP server (Cloudflare)
      community.routeros.command:
        commands:
          - /system ntp client servers add address=time.cloudflare.com
      when: not _has_ntp_cloudflare

    - name: Add NTP server (pool.ntp.org)
      community.routeros.command:
        commands:
          - /system ntp client servers add address=pool.ntp.org
      when: not _has_ntp_pool

    # ── User cleanup ───────────────────────────────────────────────────

    - name: Remove factory admin user
      community.routeros.command:
        commands:
          - /user remove [find name=admin]
      when: _has_admin_user

    # ── DHCP tuning ────────────────────────────────────────────────────

    - name: Configure DHCP settings
      community.routeros.command:
        commands:
          - /ip pool set [find name=dhcp-pool] ranges=192.168.1.50-192.168.1.199
          - /ip dhcp-server set [find name=dhcp-lan] lease-time=1d

    # ── DNS ────────────────────────────────────────────────────────────
    # DoH cert: RouterOS built-in trust store (builtin-trust-store=all) does not
    # yet include SSL.com's root CA, which Cloudflare currently uses for DoH.
    # Once a future RouterOS update adds it, this manual import can be removed
    # and verify-doh-cert=yes will work against the built-in store alone.

    - name: Upload DoH root CA certificate
      ansible.builtin.include_tasks:
        file: tasks/mikrotik-upload-and-schedule.yml
      vars:
        upload_files:
          - "{{ playbook_dir }}/files/SSLcomRootCertificationAuthorityECC.crt.pem"
      when: not _has_doh_cert

    - name: Import DoH root CA certificate and clean up
      community.routeros.command:
        commands:
          - /certificate import file-name=SSLcomRootCertificationAuthorityECC.crt.pem passphrase=""
          - /file remove SSLcomRootCertificationAuthorityECC.crt.pem
      when: not _has_doh_cert

    - name: Configure DNS with DoH
      community.routeros.command:
        commands:
          - /ip dns set servers={{ router_dns_servers }} use-doh-server=https://cloudflare-dns.com/dns-query verify-doh-cert=yes

    # Split-horizon DNS: resolve *.domain internally to the ingress VIP,
    # avoiding hairpin NAT through Cloudflare.

    - name: Add split-horizon DNS for internal services
      community.routeros.command:
        commands:
          - >-
            /ip dns static add type=A address=192.168.1.220
            regexp=".*\\.{{ cf_dns_record_name }}"
            comment="split-dns"
      when: not _has_split_dns

    # ── Static DHCP leases ─────────────────────────────────────────────

    - name: Ensure static DHCP leases are correct
      community.routeros.command:
        commands:
          - >-
            :if ([:len [/ip dhcp-server lease find mac-address={{ item.mac }} address={{ item.ip }}]] = 0) do={
            /ip dhcp-server lease remove [find mac-address={{ item.mac }}];
            /ip dhcp-server lease add address={{ item.ip }} mac-address={{ item.mac }} server=dhcp-lan comment="{{ item.name }}"
            }
      loop: "{{ router_static_leases }}"
      loop_control:
        label: "{{ item.name }} ({{ item.ip }})"

    # ── Service hardening ──────────────────────────────────────────────

    - name: Harden services
      community.routeros.command:
        commands:
          - /ip service disable telnet,ftp,api,api-ssl
          - /ip service set ssh address=192.168.1.0/24
          - /ip service set winbox address=192.168.1.0/24
          - /ip service set www address=192.168.1.0/24

    # ── Discovery hardening ────────────────────────────────────────────

    - name: Harden discovery protocols
      community.routeros.command:
        commands:
          - /tool mac-server ping set enabled=no
          - /ip neighbor discovery-settings set discover-interface-list=LAN
          - /tool bandwidth-server set enabled=no

    # ── IPv6 ──────────────────────────────────────────────────────────

    - name: Disable IPv6
      community.routeros.command:
        commands:
          - /ipv6 settings set disable-ipv6=yes

    # ── Auto-update ──────────────────────────────────────────────────

    - name: Enable firmware auto-upgrade on reboot
      community.routeros.command:
        commands:
          - /system routerboard settings set auto-upgrade=yes

    - name: Deploy auto-update scripts and schedulers
      ansible.builtin.include_tasks:
        file: tasks/mikrotik-upload-and-schedule.yml
      vars:
        upload_files:
          - "{{ playbook_dir }}/files/auto-update-packages.rsc"
          - "{{ playbook_dir }}/files/auto-update-firmware.rsc"
        schedulers:
          - name: auto-update-packages
            on_event: "/import file-name=auto-update-packages.rsc"
            start_time: "04:00:00"
            interval: 1d
          - name: auto-update-firmware
            on_event: "/import file-name=auto-update-firmware.rsc"
            start_time: "04:30:00"
            interval: 1d

    # ── Cloudflare ────────────────────────────────────────────────────

    - name: Deploy Cloudflare scripts and schedulers
      ansible.builtin.include_tasks:
        file: tasks/mikrotik-upload-and-schedule.yml
      vars:
        upload_files:
          - "{{ playbook_dir }}/files/cloudflare-firewall.rsc"
          - "{{ playbook_dir }}/files/cloudflare-ddns.rsc.j2"
        schedulers:
          - name: cloudflare-firewall-startup
            on_event: "/import file-name=cloudflare-firewall.rsc"
            start_time: startup
            interval: 0
          - name: cloudflare-firewall
            on_event: "/import file-name=cloudflare-firewall.rsc"
            start_time: "00:00:00"
            interval: 6h
          - name: cloudflare-ddns-startup
            on_event: "/import file-name=cloudflare-ddns.rsc"
            start_time: startup
            interval: 0
          - name: cloudflare-ddns
            on_event: "/import file-name=cloudflare-ddns.rsc"
            start_time: startup
            interval: 5m
