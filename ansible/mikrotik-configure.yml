---
# MikroTik Configuration Playbook
#
# Idempotent - safe to re-run. Connects as {{ ansible_user }} on 192.168.1.1
# (set up by mikrotik-bootstrap.yml). Configures system settings, DHCP,
# DNS, static leases, service hardening, firmware, and auto-updates.
#
# Configuration is defined in group_vars/router.yaml:
# - router_timezone: System timezone
# - router_dns_servers: Upstream DNS servers
# - router_static_leases: MAC-to-IP mapping (reads MAC addresses from .envrc)
#
# Usage:
#   cd ansible
#   ansible-playbook mikrotik-configure.yml

- name: Configure MikroTik router
  hosts: edge
  gather_facts: no

  vars:
    # RouterOS SSH requires a +cet<n>w suffix for terminal compatibility — handled here,
    # never in user-facing config. Mirrors bootstrap's factory_user → ansible_user pattern.
    base_user: "{{ router_user }}"
    ansible_user: "{{ router_user }}+cet512w"

  tasks:
    # ── Sanity checks ───────────────────────────────────────────────────
    # Verify bootstrap prerequisites before touching anything destructive.
    # If either check fails, run mikrotik-bootstrap.yml first.

    - name: Verify dhcp-pool exists
      community.routeros.command:
        commands:
          - ":put [:len [/ip pool find name=dhcp-pool]]"
      register: pool_check
      failed_when: pool_check.stdout[0] | int == 0

    - name: Verify dhcp-lan exists
      community.routeros.command:
        commands:
          - ":put [:len [/ip dhcp-server find name=dhcp-lan]]"
      register: lan_check
      failed_when: lan_check.stdout[0] | int == 0

    # ── System ──────────────────────────────────────────────────────────

    - name: Set system identity
      community.routeros.command:
        commands:
          - /system identity set name=edge

    - name: Set timezone
      community.routeros.command:
        commands:
          - /system clock set time-zone-name={{ router_timezone }}

    - name: Enable NTP client
      community.routeros.command:
        commands:
          - /system ntp client set enabled=yes

    - name: Set NTP servers
      community.routeros.command:
        commands:
          - ":if ([:len [/system ntp client servers find address=time.cloudflare.com]] = 0) do={ /system ntp client servers add address=time.cloudflare.com }"
          - ":if ([:len [/system ntp client servers find address=pool.ntp.org]] = 0) do={ /system ntp client servers add address=pool.ntp.org }"

    - name: Enable strong SSH crypto
      community.routeros.command:
        commands:
          - /ip ssh set strong-crypto=yes

    # ── User cleanup ───────────────────────────────────────────────────

    - name: Remove factory admin user
      community.routeros.command:
        commands:
          - /user remove [find name=admin]
      ignore_errors: true  # May already be removed

    # ── DHCP tuning ────────────────────────────────────────────────────

    - name: Set DHCP pool range to .50-.199
      community.routeros.command:
        commands:
          - /ip pool set [find name=dhcp-pool] ranges=192.168.1.50-192.168.1.199

    - name: Set DHCP lease time
      community.routeros.command:
        commands:
          - /ip dhcp-server set [find name=dhcp-lan] lease-time=1d

    # ── DNS ────────────────────────────────────────────────────────────

    - name: Set upstream DNS servers
      community.routeros.command:
        commands:
          - /ip dns set servers={{ router_dns_servers }}

    # ── Static DHCP leases ─────────────────────────────────────────────

    - name: Ensure static DHCP leases are correct
      community.routeros.command:
        commands:
          - >-
            :if ([:len [/ip dhcp-server lease find mac-address={{ item.mac }} address={{ item.ip }}]] = 0) do={
            /ip dhcp-server lease remove [find mac-address={{ item.mac }}];
            /ip dhcp-server lease add address={{ item.ip }} mac-address={{ item.mac }} server=dhcp-lan comment="{{ item.name }}"
            }
      loop: "{{ router_static_leases }}"
      loop_control:
        label: "{{ item.name }} ({{ item.ip }})"

    # ── Service hardening ──────────────────────────────────────────────

    - name: Harden services
      community.routeros.command:
        commands:
          - /ip service disable telnet,ftp,api,api-ssl
          - /ip service set ssh address=192.168.1.0/24
          - /ip service set winbox address=192.168.1.0/24
          - /ip service set www address=192.168.1.0/24

    # ── Discovery hardening ────────────────────────────────────────────

    - name: Harden discovery protocols
      community.routeros.command:
        commands:
          - /tool mac-server ping set enabled=no
          - /ip neighbor discovery-settings set discover-interface-list=LAN
          - /tool bandwidth-server set enabled=no

    # ── Auto-update ──────────────────────────────────────────────────

    - name: Enable firmware auto-upgrade on reboot
      community.routeros.command:
        commands:
          - /system routerboard settings set auto-upgrade=yes

    - name: Deploy auto-update scripts and schedulers
      ansible.builtin.include_tasks:
        file: tasks/mikrotik-upload-and-schedule.yml
      vars:
        upload_files:
          - "{{ playbook_dir }}/files/auto-update-packages.rsc"
          - "{{ playbook_dir }}/files/auto-update-firmware.rsc"
        schedulers:
          - name: auto-update-packages
            on_event: "/import file-name=auto-update-packages.rsc"
            start_time: "04:00:00"
            interval: 1d
          - name: auto-update-firmware
            on_event: "/import file-name=auto-update-firmware.rsc"
            start_time: "04:30:00"
            interval: 1d

    # ── Cloudflare ────────────────────────────────────────────────────

    - name: Deploy Cloudflare scripts and schedulers
      ansible.builtin.include_tasks:
        file: tasks/mikrotik-upload-and-schedule.yml
      vars:
        upload_files:
          - "{{ playbook_dir }}/files/cloudflare-firewall.rsc"
          - "{{ playbook_dir }}/files/cloudflare-ddns.rsc.j2"
        schedulers:
          - name: cloudflare-firewall-startup
            on_event: "/import file-name=cloudflare-firewall.rsc"
            start_time: startup
            interval: 0
          - name: cloudflare-firewall
            on_event: "/import file-name=cloudflare-firewall.rsc"
            start_time: "00:00:00"
            interval: 6h
          - name: cloudflare-ddns-startup
            on_event: "/import file-name=cloudflare-ddns.rsc"
            start_time: startup
            interval: 0
          - name: cloudflare-ddns
            on_event: "/import file-name=cloudflare-ddns.rsc"
            start_time: startup
            interval: 5m
    # ── Cleanup ────────────────────────────────────────────────────────

    - name: Remove bootstrap artifacts from router
      community.routeros.command:
        commands:
          - /file remove bootstrap-migrate-subnet.rsc
      ignore_errors: true
